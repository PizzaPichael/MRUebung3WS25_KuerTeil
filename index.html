<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>WebXR API / A-Frame: Ch.8 Ex.7 Pts.1 & 2</title>
    <script src="https://aframe.io/releases/1.7.0/aframe.min.js"></script>
    <script src="/src/depth-features.js"></script>
  </head>
  <body>
    <a-scene
      xr-mode-ui="enterAREnabled: true; enterVREnabled: false; XRMode: ar"
    >
      <!-- key to add in the scene component: real-world-meshing -->
      <a-assets>
        <a-asset-item
          id="throneroom"
          src="/src/models/throneroom/throneroom_project.gltf"
        ></a-asset-item>
        <a-asset-item
          id="lightbulb"
          src="/src/models/paper_mario_sticker_star_lightbulb/scene.gltf"
        ></a-asset-item>
        <a-asset-item
          id="xyzindicator"
          src="/src/models/xyz_axis/scene.gltf"
        ></a-asset-item>
        <img
          id="computerBaseTexture"
          src="/src/models/old_retro_stylized_computer/textures/Scene_-_Root_baseColor.png"
        />
        <img
          id="groundTexture"
          src="/src/textures/old_linoleum_flooring_01_1k.blend/old_linoleum_flooring_01_diff_1k.jpg"
        />
        <a-asset-item
          id="fackelasset"
          src="/src/models/Free_Pillar_Torch_gltf/fbxPillar.gltf"
        ></a-asset-item>
      </a-assets>

      <!-- Glühbirne in der Mitte des Raumes -->
      <a-entity
        id="lightbulb"
        gltf-model="#lightbulb"
        position="0 1.5 -50"
        scale="0.1 0.1 0.1"
      ></a-entity>
    </a-scene>
    <script>
      // Korrekte Depth-Sensing Session-Konfiguration
      AFRAME.registerComponent('depth-session-config', {
        init: function () {
          const sceneEl = this.el;

          // Überschreibe die Session-Konfiguration
          sceneEl.addEventListener('loaded', () => {
            const originalRequestSession = navigator.xr.requestSession.bind(
              navigator.xr
            );

            navigator.xr.requestSession = function (mode, options = {}) {
              if (mode === 'immersive-ar') {
                options.requiredFeatures = options.requiredFeatures || [];
                options.requiredFeatures.push('depth-sensing', 'hit-test');

                options.depthSensing = {
                  usagePreference: ['cpu-optimized', 'gpu-optimized'],
                  dataFormatPreference: ['luminance-alpha', 'float32'],
                };
              }
              return originalRequestSession(mode, options);
            };
          });
        },
      });

      AFRAME.registerComponent('enable-depth', {
        init: function () {
          this.el.sceneEl.addEventListener('enter-vr', () => {
            const session = this.el.sceneEl.renderer.xr.getSession();
            if (session) {
              // Depth-Daten sind nun verfügbar
            }
          });
        },
        tick: function () {
          const frame = this.el.sceneEl.frame;
          if (frame) {
            const pose = frame.getViewerPose(referenceSpace);
            if (pose) {
              for (const view of pose.views) {
                const depthInfo = frame.getDepthInformation(view);
                if (depthInfo) {
                  // Nutze depthInfo.data, depthInfo.width, depthInfo.height
                }
              }
            }
          }
        },
      });
    </script>
  </body>
</html>
